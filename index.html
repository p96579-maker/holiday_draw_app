<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>å‡æœŸæŠ½ç±¤ç³»çµ± v8</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Arial, sans-serif;
      background: #eef1f6;
      padding: 0;
      margin: 0;
      color: #111827;
    }
    .container { max-width: 900px; margin: 32px auto; padding: 0 16px; }
    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.1);
      margin-bottom: 18px;
    }
    h1 { margin: 0; font-size: 26px; display:flex; align-items:center; gap:8px; }
    .logo-dot { width:12px; height:12px; background:#4f46e5; border-radius:50%; }
    .subtitle { margin-top:4px; font-size:14px; color:#6b7280; }

    .section-title { margin-top:20px; font-weight:700; font-size:15px; }

    .divider { height:1px; background:#d1d5db; margin:20px 0; }

    label { font-size:14px; margin-bottom:6px; font-weight:600; display:block; }

    .grid-3 { display:grid; grid-template-columns:1.1fr 1fr 0.8fr; gap:12px; }
    @media(max-width:780px){ .grid-3 { grid-template-columns:1fr; } }

    select, input[type="date"], input[type="number"] {
      width:100%; padding:8px 12px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
    }
    select:focus, input:focus {
      outline:none;
      border-color:#4f46e5;
      box-shadow:0 0 0 1px rgba(79,70,229,0.22);
    }

    button {
      padding: 8px 18px;
      font-size: 14px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      transition:0.1s;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary { background:#4f46e5; color:white; }
    .btn-primary:hover { background:#4338ca; }
    .btn-secondary { background:#e5e7eb; color:#374151; }
    .btn-secondary:hover { background:#d1d5db; }
    .btn-ghost { background:transparent; color:#374151; }
    .btn-ghost:hover { background:#e5e7eb; }

    /* äººå pill */
    .pill-people-wrapper {
      margin-top: 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      padding:10px;
    }
    .pill-people-container {
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .pill-person {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px;
      font-size:14px;
      border:1px solid #cbd5f5;
      border-radius:999px;
      cursor:pointer;
      background:white;
      transition:0.15s;
    }
    .pill-person.checked {
      background:#2563eb;
      border-color:#1d4ed8;
      color:white;
      box-shadow:0 4px 10px rgba(37,99,235,0.35);
    }
    input[type="checkbox"] { width:18px; height:18px; accent-color:#2563eb; }

    /* çµæœå€ */
    .result-box {
      margin-top: 18px;
      padding: 18px 20px;
      border-radius: 12px;
      background: #f9fafb;
      border: 2px solid #cbd5f5;
      font-size: 16px;
      line-height: 1.65;
    }
    .result-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .result-title { font-size:18px; font-weight:700; }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .badge-gray { background:#e5e7eb; color:#374151; }
    .badge-green { background:#d1fae5; color:#166534; }

    .result-main-header { font-weight:700; margin-bottom:4px; }
    .result-sub { font-size:14px; color:#4b5563; margin-bottom:10px; }

    .winners-box {
      border-radius:10px;
      background:#dcfce7;
      border:1px solid #16a34a;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .winners-title {
      font-weight:700;
      color:#166534;
      margin-bottom:4px;
    }
    .winner-name { padding-left:10px; }

    .losers-title {
      font-weight:700;
      margin-top:6px;
      margin-bottom:2px;
    }
    .loser-name { padding-left:10px; }

    .result-note { margin-top:8px; font-size:14px; color:#374151; }

    /* æ­·å²ç´€éŒ„ */
    .history-title { font-size:16px; font-weight:700; margin-bottom:8px; }
    .history-list { max-height:260px; overflow-y:auto; }
    .history-item {
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      margin-bottom:8px;
      background:#f9fafb;
      font-size:13px;
    }
    .history-meta {
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
      margin-bottom:4px;
    }
    .history-text { white-space:pre-line; }
  </style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1><span class="logo-dot"></span>å‡æœŸæŠ½ç±¤ç³»çµ± v8</h1>
    <div class="subtitle">ä¸­ç±¤åå–®ç¶ è‰²æ¡†çªå‡ºã€å¯ä»¥ä¸€éµè¤‡è£½çµæœï¼Œä¸¦è‡ªå‹•ä¿å­˜æ­·å²ç´€éŒ„ã€‚</div>

    <div class="section-title">æ€å‡æœŸ + æ—¥å­ + åé¡</div>

    <div class="grid-3">
      <div>
        <label>å‡æœŸ</label>
        <select id="holiday-select">
          <option value="cny">è¾²æ›†æ–°å¹´</option>
          <option value="easter">å¾©æ´»ç¯€</option>
          <option value="xmas">è–èª•ç¯€</option>
        </select>
      </div>

      <div>
        <label>æ—¥æœŸï¼ˆç”±å¹¾è™Ÿè‡³å¹¾è™Ÿï¼‰</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <input type="date" id="holiday-start">
          <input type="date" id="holiday-end">
        </div>
      </div>

      <div>
        <label>ä¸­ç±¤åé¡</label>
        <input type="number" id="quota-input" min="1" value="2">
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">tick äººå â†’ æŠ½ç±¤</div>

    <div class="pill-people-wrapper">
      <div style="font-size:14px; font-weight:600; margin-bottom:6px;">
        å·² tick äººæ•¸ï¼š <span id="people-count-label"></span>
      </div>
      <div id="pill-people-container" class="pill-people-container"></div>
    </div>

    <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
      <div>
        <button class="btn-ghost" id="select-all-btn">å…¨é¸</button>
        <button class="btn-ghost" id="select-none-btn">å…¨éƒ¨å–æ¶ˆ</button>
        <button class="btn-ghost" id="select-random-half-btn">éš¨æ©Ÿ tick ä¸€åŠ</button>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn-secondary" id="copy-btn">ğŸ“‹ Copy çµæœ</button>
        <button class="btn-secondary" id="clear-result-btn">æ¸…é™¤çµæœ</button>
        <button class="btn-primary" id="draw-btn">ğŸ² æŠ½ç±¤</button>
      </div>
    </div>

    <div class="result-box">
      <div class="result-header">
        <div class="result-title">æŠ½ç±¤çµæœ</div>
        <span class="badge badge-gray" id="result-status">æœªæŠ½ç±¤</span>
      </div>
      <div id="result">
        æš«æ™‚ä»²æœªæœ‰çµæœã€‚
      </div>
    </div>
  </div>

  <div class="card">
    <div class="history-title">æ­·å²ç´€éŒ„ï¼ˆåªå„²å­˜åœ¨ä½ ç€è¦½å™¨ï¼‰</div>
    <div id="history-list" class="history-list">
      <div style="font-size:13px; color:#6b7280;">æš«æ™‚æœªæœ‰ç´€éŒ„ã€‚</div>
    </div>
  </div>
</div>

<script>
  const people = [
    "CW LI","YK CHOW","CK LEUNG","YP WONG","KC CHAN",
    "MT CHU","HL CHEUNG","PF HO","CL KWONG","PH LAO",
    "YK LAU","WH LO","WW NG","YC WONG","CK YUEN",
    "WC AUYEUNG","TW CHAN","TK KWOK","YT SIU","TF TAM"
  ];
  const holidayLabels = { cny:"è¾²æ›†æ–°å¹´", easter:"å¾©æ´»ç¯€", xmas:"è–èª•ç¯€" };
  const STORAGE_KEY = "holiday_draw_history_v1";

  const pillContainer = document.getElementById("pill-people-container");
  const peopleCountLabel = document.getElementById("people-count-label");
  const resultDiv = document.getElementById("result");
  const resultStatus = document.getElementById("result-status");
  const historyList = document.getElementById("history-list");
  let lastPlainText = "";

  function buildPills() {
    pillContainer.innerHTML = "";
    people.forEach((name, idx) => {
      const label = document.createElement("label");
      label.className = "pill-person";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.index = idx;

      cb.addEventListener("change", ()=>{
        if(cb.checked) label.classList.add("checked");
        else label.classList.remove("checked");
        updatePeopleCount();
      });

      label.appendChild(cb);
      label.appendChild(document.createTextNode(name));
      pillContainer.appendChild(label);
    });
    updatePeopleCount();
  }

  function getCheckboxes() {
    return Array.from(document.querySelectorAll("input[type='checkbox']"));
  }

  function getChecked() {
    return getCheckboxes().filter(c=>c.checked);
  }

  function updatePeopleCount() {
    peopleCountLabel.textContent = getChecked().length + " äºº";
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  function drawLots(){
    const checked = getChecked();
    if(checked.length===0){ alert("è«‹ tick åƒåŠ è€…"); return; }

    const holidayId = document.getElementById("holiday-select").value;
    const holiday = holidayLabels[holidayId] || "å‡æœŸ";
    const start = document.getElementById("holiday-start").value || "?";
    const end = document.getElementById("holiday-end").value || "?";
    const quotaInput = document.getElementById("quota-input");
    let q = parseInt(quotaInput.value,10);
    if(isNaN(q) || q<=0) q = 1;
    if(q > checked.length) q = checked.length;
    quotaInput.value = q;

    const indices = checked.map(cb=>parseInt(cb.dataset.index,10));
    shuffle(indices);
    const winnersIdx = indices.slice(0,q);
    const losersIdx = indices.slice(q);

    const winnerNames = winnersIdx.map(i=>people[i]);
    const loserNames = losersIdx.map(i=>people[i]);

    // Build HTML result
    let html = "";
    html += `<div class="result-main-header">ã€${holiday}ã€‘ï¼ˆ${start} è‡³ ${end}ï¼‰</div>`;
    html += `<div class="result-sub">åé¡ï¼š${q}ã€€ï½œã€€åƒåŠ äººæ•¸ï¼š${checked.length}</div>`;

    html += `<div class="winners-box">`;
    html += `<div class="winners-title">âœ… ä¸­ç±¤ï¼š</div>`;
    winnerNames.forEach(name=>{
      html += `<div class="winner-name">â€¢ ${name}</div>`;
    });
    html += `</div>`;

    if(loserNames.length>0){
      html += `<div class="losers-title">âŒ è½é¸ï¼š</div>`;
      loserNames.forEach(name=>{
        html += `<div class="loser-name">â€¢ ${name}</div>`;
      });
    }

    html += `<div class="result-note">ğŸ“Œ æç¤ºï¼šä¸­ç±¤è€…å¯ä»¥é¸æ“‡ç•¶æ¬¡æ‰€éœ€è¦çš„å‡æœŸã€‚</div>`;

    resultDiv.innerHTML = html;
    resultStatus.textContent = "å®Œæˆ";
    resultStatus.className = "badge badge-green";

    // Build plain text for copy & history
    let txt = `ã€${holiday}ã€‘ï¼ˆ${start} è‡³ ${end}ï¼‰\nåé¡ï¼š${q}ï¼ˆå…± ${checked.length} äººåƒåŠ ï¼‰\n\n`;
    txt += "âœ… ä¸­ç±¤ï¼š\n";
    winnerNames.forEach(n=>{ txt += "  â€¢ " + n + "\n"; });
    if(loserNames.length>0){
      txt += "\nâŒ è½é¸ï¼š\n";
      loserNames.forEach(n=>{ txt += "  â€¢ " + n + "\n"; });
    }
    txt += "\nğŸ“Œ æç¤ºï¼šä¸­ç±¤è€…å¯ä»¥é¸æ“‡ç•¶æ¬¡æ‰€éœ€è¦çš„å‡æœŸã€‚";
    lastPlainText = txt;

    saveHistory({ holidayId, holiday, start, end, quota:q, participants:checked.length, winners:winnerNames, losers:loserNames, text:txt, time:new Date().toISOString() });
    renderHistory();
  }

  function clearResult(){
    resultDiv.textContent = "æš«æ™‚ä»²æœªæœ‰çµæœã€‚";
    resultStatus.textContent = "æœªæŠ½ç±¤";
    resultStatus.className = "badge badge-gray";
    lastPlainText = "";
  }

  function copyResult(){
    const text = lastPlainText || resultDiv.textContent.trim();
    if(!text){ return; }
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>{
        const btn = document.getElementById("copy-btn");
        const old = btn.textContent;
        btn.textContent = "âœ… å·²è¤‡è£½";
        setTimeout(()=>{ btn.textContent = "ğŸ“‹ Copy çµæœ"; }, 1200);
      }).catch(()=>{
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text){
    const textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try { document.execCommand("copy"); } catch(e){}
    document.body.removeChild(textarea);
    alert("å·²è¤‡è£½çµæœã€‚");
  }

  // History functions
  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      if(Array.isArray(data)) return data;
    }catch(e){}
    return [];
  }

  function saveHistoryEntryArray(arr){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }catch(e){}
  }

  function saveHistory(entry){
    let arr = loadHistory();
    arr.push(entry);
    if(arr.length > 50) arr = arr.slice(arr.length-50); // keep last 50
    saveHistoryEntryArray(arr);
  }

  function renderHistory(){
    const arr = loadHistory().slice().reverse(); // newest first
    historyList.innerHTML = "";
    if(arr.length === 0){
      historyList.innerHTML = '<div style="font-size:13px; color:#6b7280;">æš«æ™‚æœªæœ‰ç´€éŒ„ã€‚</div>';
      return;
    }
    arr.forEach(item=>{
      const div = document.createElement("div");
      div.className = "history-item";
      const timeStr = new Date(item.time).toLocaleString("zh-HK", { hour12:false });
      div.innerHTML = `
        <div class="history-meta">
          <span>${item.holiday}ï¼ˆ${item.start} è‡³ ${item.end}ï¼‰</span>
          <span>${timeStr}</span>
        </div>
        <div class="history-text">${item.text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
      `;
      historyList.appendChild(div);
    });
  }

  function selectAll(){
    getCheckboxes().forEach(cb=>{
      cb.checked = true;
      cb.closest(".pill-person").classList.add("checked");
    });
    updatePeopleCount();
  }

  function selectNone(){
    getCheckboxes().forEach(cb=>{
      cb.checked = false;
      cb.closest(".pill-person").classList.remove("checked");
    });
    updatePeopleCount();
  }

  function selectRandomHalf(){
    const boxes = getCheckboxes();
    if(!boxes.length) return;
    selectNone();
    const idxs = boxes.map((_,i)=>i);
    shuffle(idxs);
    const half = Math.ceil(idxs.length/2);
    const chosen = new Set(idxs.slice(0,half));
    boxes.forEach((cb,i)=>{
      if(chosen.has(i)){
        cb.checked = true;
        cb.closest(".pill-person").classList.add("checked");
      }
    });
    updatePeopleCount();
  }

  // Event binding
  document.getElementById("draw-btn").onclick = drawLots;
  document.getElementById("clear-result-btn").onclick = clearResult;
  document.getElementById("copy-btn").onclick = copyResult;
  document.getElementById("select-all-btn").onclick = selectAll;
  document.getElementById("select-none-btn").onclick = selectNone;
  document.getElementById("select-random-half-btn").onclick = selectRandomHalf;

  // init
  buildPills();
  clearResult();
  renderHistory();
</script>

</body>
</html>
