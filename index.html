<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>C TEAM - å‡æœŸæŠ½ç±¤ç³»çµ±</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Arial, sans-serif;
      background: #eef1f6;
      padding: 0;
      margin: 0;
      color: #111827;
    }
    .container { max-width: 900px; margin: 32px auto; padding: 0 16px; }
    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.1);
      margin-bottom: 18px;
    }
    h1 { margin: 0; font-size: 26px; display:flex; align-items:center; gap:8px; }
    .logo-dot { width:12px; height:12px; background:#4f46e5; border-radius:50%; }
    .subtitle { margin-top:4px; font-size:14px; color:#6b7280; }

    .section-title { margin-top:20px; font-weight:700; font-size:15px; }

    .divider { height:1px; background:#d1d5db; margin:20px 0; }

    label { font-size:14px; margin-bottom:6px; font-weight:600; display:block; }

    .grid-3 { display:grid; grid-template-columns:1.1fr 1fr 0.8fr; gap:12px; }
    @media(max-width:780px){ .grid-3 { grid-template-columns:1fr; } }

    select, input[type="date"], input[type="number"] {
      width:100%; padding:8px 12px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
    }
    select:focus, input:focus {
      outline:none;
      border-color:#4f46e5;
      box-shadow:0 0 0 1px rgba(79,70,229,0.22);
    }

    button {
      padding: 8px 18px;
      font-size: 14px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      transition:0.1s;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary { background:#4f46e5; color:white; }
    .btn-primary:hover { background:#4338ca; }
    .btn-secondary { background:#e5e7eb; color:#374151; }
    .btn-secondary:hover { background:#d1d5db; }
    .btn-ghost { background:transparent; color:#374151; }
    .btn-ghost:hover { background:#e5e7eb; }

    /* äººå pill */
    .pill-people-wrapper {
      margin-top: 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      padding:10px;
    }
    .pill-people-container {
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .pill-person {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px;
      font-size:14px;
      border:1px solid #cbd5f5;
      border-radius:999px;
      cursor:pointer;
      background:white;
      transition:0.15s;
    }
    .pill-person.checked {
      background:#2563eb;
      border-color:#1d4ed8;
      color:white;
      box-shadow:0 4px 10px rgba(37,99,235,0.35);
    }
    .pill-person.disabled {
      opacity:0.45;
      cursor:not-allowed;
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .pill-person.disabled input[type="checkbox"] {
      cursor:not-allowed;
    }
    input[type="checkbox"] { width:18px; height:18px; accent-color:#2563eb; }

    .hint-small { font-size:12px; color:#6b7280; margin-top:4px; }

    /* çµæœå€ */
    .result-box {
      margin-top: 18px;
      padding: 18px 20px;
      border-radius: 12px;
      background: #f9fafb;
      border: 2px solid #cbd5f5;
      font-size: 16px;
      line-height: 1.65;
    }
    .result-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .result-title { font-size:18px; font-weight:700; }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .badge-gray { background:#e5e7eb; color:#374151; }
    .badge-green { background:#d1fae5; color:#166534; }

    .result-main-header { font-weight:700; margin-bottom:4px; }
    .result-sub { font-size:14px; color:#4b5563; margin-bottom:10px; }

    .winners-box {
      border-radius:10px;
      background:#dcfce7;
      border:1px solid #16a34a;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .winners-title {
      font-weight:700;
      color:#166534;
      margin-bottom:4px;
    }
    .winner-name { padding-left:10px; }

    .losers-title {
      font-weight:700;
      margin-top:6px;
      margin-bottom:2px;
    }
    .loser-name { padding-left:10px; }

    .result-note { margin-top:8px; font-size:14px; color:#374151; }

    /* æ­·å²ç´€éŒ„ */
    .history-title { font-size:16px; font-weight:700; margin-bottom:8px; }
    .history-list { max-height:260px; overflow-y:auto; }
    .history-item {
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      margin-bottom:8px;
      background:#f9fafb;
      font-size:13px;
    }
    .history-meta {
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
      margin-bottom:4px;
      flex-wrap:wrap;
      gap:6px;
    }
    .history-text { white-space:pre-line; }
    .history-rule-tag {
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#eef2ff;
      color:#4f46e5;
    }
    .history-delete-btn {
      border-radius:999px;
      border:none;
      background:transparent;
      color:#9ca3af;
      font-size:12px;
      cursor:pointer;
      padding:2px 6px;
    }
    .history-delete-btn:hover {
      background:#fee2e2;
      color:#b91c1c;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1><span class="logo-dot"></span>C TEAM - å‡æœŸæŠ½ç±¤ç³»çµ±</h1>
    <div class="subtitle">
      æ”¯æ´ï¼šé€£çºŒå…©æ¬¡ä¸­ç±¤ä¸‹ä¸€æ¬¡è‡ªå‹•åœä¸€è¼ªã€ä¸‰æ¬¡è½é¸ä¸‹ä¸€æ¬¡å¿…ä¸­ã€çµæœæ­·å²ã€è‡ªé¸åˆªé™¤å–®æ¢ç´€éŒ„ã€‚
    </div>

    <div class="section-title">æ€å‡æœŸ + æ—¥å­ + åé¡</div>

    <div class="grid-3">
      <div>
        <label>å‡æœŸ</label>
        <select id="holiday-select">
          <option value="cny">è¾²æ›†æ–°å¹´</option>
          <option value="easter">å¾©æ´»ç¯€</option>
          <option value="xmas">è–èª•ç¯€</option>
        </select>
      </div>

      <div>
        <label>æ—¥æœŸï¼ˆç”±å¹¾è™Ÿè‡³å¹¾è™Ÿï¼‰</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <input type="date" id="holiday-start">
          <input type="date" id="holiday-end">
        </div>
      </div>

      <div>
        <label>ä¸­ç±¤åé¡</label>
        <input type="number" id="quota-input" min="1" value="2">
        <div class="hint-small">* å¦‚æœ‰å¤šä½ã€Œä¸‰æ¬¡è½é¸ã€å¿…ä¸­ï¼Œä¸­ç±¤äººæ•¸å¯èƒ½æœƒå¤šéè¨­å®šåé¡ã€‚</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">æ€äººå â†’ æŠ½ç±¤</div>

    <div class="pill-people-wrapper">
      <div style="font-size:14px; font-weight:600; margin-bottom:4px;">
        å·²æ€äººæ•¸ï¼š <span id="people-count-label"></span>
      </div>
      <div class="hint-small">
        è¦å‰‡ï¼šâ‘  é€£çºŒ 2 æ¬¡ä¸­ç±¤è€…ï¼Œä¸‹ä¸€æ¬¡æŠ½ç±¤çš„äººåæœƒè®Šç°å””æ¯”æ€ï¼Œè©²æ¬¡æŠ½å®Œè‡ªå‹•è§£ç¦ï¼›â‘¡ é€£çºŒ 3 æ¬¡è½é¸è€…ï¼Œä¸‹æ¬¡åƒåŠ å¿…ä¸­ã€‚
      </div>
      <div id="pill-people-container" class="pill-people-container"></div>
    </div>

    <div style="margin-top:12px; display:flex; justify-content:flex-end; align-items:center; flex-wrap:wrap; gap:8px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn-secondary" id="reset-rules-btn">â™» RESET ç´¯ç©è¨˜éŒ„</button>
        <button class="btn-secondary" id="copy-btn">ğŸ“‹ Copy çµæœ</button>
        <button class="btn-secondary" id="clear-result-btn">æ¸…é™¤çµæœ</button>
        <button class="btn-primary" id="draw-btn">ğŸ² æŠ½ç±¤</button>
      </div>
    </div>

    <div class="result-box">
      <div class="result-header">
        <div class="result-title">æŠ½ç±¤çµæœ</div>
        <span class="badge badge-gray" id="result-status">æœªæŠ½ç±¤</span>
      </div>
      <div id="result">
        æš«æ™‚ä»²æœªæœ‰çµæœã€‚
      </div>
    </div>
  </div>

  <div class="card">
    <div class="history-title">æ­·å²ç´€éŒ„ï¼ˆåªå„²å­˜åœ¨ä½ ç€è¦½å™¨ï¼‰</div>
    <div id="history-list" class="history-list">
      <div style="font-size:13px; color:#6b7280;">æš«æ™‚æœªæœ‰ç´€éŒ„ã€‚</div>
    </div>
  </div>
</div>

<script>
  const people = [
    "CW LI","YK CHOW","CK LEUNG","YP WONG","KC CHAN",
    "MT CHU","HL CHEUNG","PF HO","CL KWONG","PH LAO",
    "YK LAU","WH LO","WW NG","YC WONG","CK YUEN",
    "WC AUYEUNG","TW CHAN","TK KWOK","YT SIU","TF TAM"
  ];
  const holidayLabels = { cny:"è¾²æ›†æ–°å¹´", easter:"å¾©æ´»ç¯€", xmas:"è–èª•ç¯€" };
  const STORAGE_KEY = "holiday_draw_history_v1";
  const STREAK_KEY  = "holiday_draw_streak_v2"; // name -> {wins, losses, bannedNext:boolean}

  const pillContainer = document.getElementById("pill-people-container");
  const peopleCountLabel = document.getElementById("people-count-label");
  const resultDiv = document.getElementById("result");
  const resultStatus = document.getElementById("result-status");
  const historyList = document.getElementById("history-list");
  let lastPlainText = "";

  function loadStreaks(){
    try{
      const raw = localStorage.getItem(STREAK_KEY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj==="object" ? obj : {};
    }catch(e){ return {}; }
  }

  function saveStreaks(streaks){
    try{
      localStorage.setItem(STREAK_KEY, JSON.stringify(streaks));
    }catch(e){}
  }

  function buildPills() {
    const streaks = loadStreaks();
    pillContainer.innerHTML = "";
    people.forEach((name, idx) => {
      const st = streaks[name] || {wins:0, losses:0, bannedNext:false};
      if (typeof st.bannedNext !== "boolean") st.bannedNext = false;
      const disabled = !!st.bannedNext;          // åªç‡ bannedNext

      const mustWin  = st.losses >= 3;           // é€£çºŒ 3 æ¬¡è½é¸ â†’ ä¸‹æ¬¡å¿…ä¸­

      const label = document.createElement("label");
      label.className = "pill-person";
      if(disabled) label.classList.add("disabled");
      if(mustWin && !disabled) label.style.borderColor = "#f97316"; // æ©™è‰²é‚Šæç¤º

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.index = idx;
      cb.disabled = disabled;

      cb.addEventListener("change", ()=>{
        if(cb.checked) label.classList.add("checked");
        else label.classList.remove("checked");
        updatePeopleCount();
      });

      label.appendChild(cb);

      let displayName = name;
      if(disabled){
        displayName += "ï¼ˆé€£çºŒ 2 æ¬¡ä¸­ç±¤ï¼Œä»Šæ¬¡æš«åœæŠ½ç±¤ï¼‰";
      } else if(mustWin){
        displayName += "ï¼ˆé€£çºŒ 3 æ¬¡è½é¸ï¼Œä¸‹æ¬¡å¿…ä¸­ï¼‰";
      }
      label.appendChild(document.createTextNode(displayName));
      pillContainer.appendChild(label);
    });
    updatePeopleCount();
  }

  function getCheckboxes() {
    return Array.from(document.querySelectorAll("input[type='checkbox']"));
  }

  function getChecked() {
    return getCheckboxes().filter(c=>c.checked && !c.disabled);
  }

  function updatePeopleCount() {
    peopleCountLabel.textContent = getChecked().length + " äºº";
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  function drawLots(){
    const checked = getChecked();
    if(checked.length===0){ alert("è«‹ tick åƒåŠ è€…ï¼ˆç°è‰²ç‚ºä»Šæ¬¡æš«åœæŠ½ç±¤ï¼‰"); return; }

    const holidayId = document.getElementById("holiday-select").value;
    const holiday = holidayLabels[holidayId] || "å‡æœŸ";
    const start = document.getElementById("holiday-start").value || "?";
    const end = document.getElementById("holiday-end").value || "?";
    const quotaInput = document.getElementById("quota-input");
    let q = parseInt(quotaInput.value,10);
    if(isNaN(q) || q<=0) q = 1;
    quotaInput.value = q;

    const streaks = loadStreaks();

    // è¨˜ä½ä»Šæ¬¡ä¹‹å‰ï¼Œé‚Šå•²äººä¿‚è¢« banï¼ˆç”¨åšŸå–ºæŠ½å®Œä¹‹å¾Œè§£ç¦ï¼‰
    const wasBannedThisRound = {};
    people.forEach(name => {
      const st = streaks[name] || {wins:0, losses:0, bannedNext:false};
      wasBannedThisRound[name] = !!st.bannedNext;
    });

    // åƒåŠ è€… index listï¼ˆå·²ç¶“æ’é™¤ disabledï¼‰
    const participantIdx = checked.map(cb=>parseInt(cb.dataset.index,10));

    // è¦å‰‡2ï¼šé€£çºŒä¸‰æ¬¡è½é¸è€…ï¼Œä»Šæ¬¡å¿…ä¸­
    const mustWinIdx = participantIdx.filter(i => {
      const st = streaks[people[i]] || {wins:0, losses:0, bannedNext:false};
      return st.losses >= 3;
    });

    // åˆæ­¥ winners = å¿…ä¸­è€…
    let winnersIdx = [...mustWinIdx];

    // å‰©é¤˜åé¡ï¼ˆå¦‚æœå¿…ä¸­å·²ç¶“ >= qï¼Œå‰‡å¯¦éš›æœƒå¤šéè¨­å®šåé¡ï¼‰
    const remainingCandidates = participantIdx.filter(i => !winnersIdx.includes(i));
    const quotaForRandom = Math.max(0, q - winnersIdx.length);

    shuffle(remainingCandidates);
    const randomWinners = remainingCandidates.slice(0, quotaForRandom);
    winnersIdx = winnersIdx.concat(randomWinners);

    // losers = å…¶é¤˜åƒåŠ è€…
    const losersIdx = participantIdx.filter(i => !winnersIdx.includes(i));

    const winnerNames = winnersIdx.map(i=>people[i]);
    const loserNames = losersIdx.map(i=>people[i]);

    // æ›´æ–° streaksï¼šåªè¨ˆæœ‰åƒåŠ çš„äºº wins / losses
    participantIdx.forEach(i=>{
      const name = people[i];
      const st = streaks[name] || {wins:0, losses:0, bannedNext:false};
      if(winnersIdx.includes(i)){
        st.wins = (st.wins || 0) + 1;
        st.losses = 0;
      }else{
        st.losses = (st.losses || 0) + 1;
        st.wins = 0;
      }
      streaks[name] = st;
    });

    // å…ˆè™•ç†ã€Œä»Šæ¬¡è¢« ban å˜…äººã€ï¼šä½¢å“‹å·²ç¶“æœå®Œ banï¼Œç„¡è«–æœ‰å†‡åƒèˆ‡ä»Šæ¬¡ï¼Œéƒ½è¦è§£ç¦
    people.forEach(name => {
      const st = streaks[name] || {wins:0, losses:0, bannedNext:false};
      if(wasBannedThisRound[name]){
        st.bannedNext = false;
      }
      streaks[name] = st;
    });

    // å†è™•ç†æ–°è§¸ç™¼ã€Œé€£çºŒ 2 æ¬¡ä¸­ç±¤ â†’ ä¸‹ä¸€æ¬¡ banã€
    participantIdx.forEach(i=>{
      const name = people[i];
      const st = streaks[name] || {wins:0, losses:0, bannedNext:false};
      if(st.wins >= 2){
        st.bannedNext = true;   // ä¸‹ä¸€æ¬¡æŠ½ç±¤æœƒç°å·¦å””æ¯”æ€
        st.wins = 0;            // ç”¨å®Œä¹‹å¾Œç”±é ­å†è¨ˆé€£å‹
      }
      streaks[name] = st;
    });

    saveStreaks(streaks);

    // ç”Ÿæˆ HTML çµæœ
    let html = "";
    html += `<div class="result-main-header">ã€${holiday}ã€‘ï¼ˆ${start} è‡³ ${end}ï¼‰</div>`;
    const showQuota = winnersIdx.length > q ? `${q}ï¼ˆå¯¦éš›ä¸­ç±¤ ${winnersIdx.length} äººï¼‰` : `${q}`;
    html += `<div class="result-sub">åé¡ï¼š${showQuota}ã€€ï½œã€€åƒåŠ äººæ•¸ï¼š${participantIdx.length}</div>`;

    html += `<div class="winners-box">`;
    html += `<div class="winners-title">âœ… ä¸­ç±¤ï¼š</div>`;
    winnerNames.forEach(name=>{
      html += `<div class="winner-name">â€¢ ${name}</div>`;
    });
    html += `</div>`;

    if(loserNames.length>0){
      html += `<div class="losers-title">âŒ è½é¸ï¼š</div>`;
      loserNames.forEach(name=>{
        html += `<div class="loser-name">â€¢ ${name}</div>`;
      });
    }

    html += `<div class="result-note">ğŸ“Œ æç¤ºï¼šä¸­ç±¤è€…å¯ä»¥é¸æ“‡ç•¶æ¬¡æ‰€éœ€è¦çš„å‡æœŸã€‚<br>è¦å‰‡ï¼šé€£çºŒ 2 æ¬¡ä¸­ç±¤è€…ï¼Œä¸‹ä¸€æ¬¡æŠ½ç±¤æœƒè‡ªå‹•æš«åœä¸€æ¬¡ï¼›é€£çºŒ 3 æ¬¡è½é¸è€…ï¼Œä¸‹æ¬¡åƒåŠ å¿…ä¸­ã€‚</div>`;

    resultDiv.innerHTML = html;
    resultStatus.textContent = "å®Œæˆ";
    resultStatus.className = "badge badge-green";

    // ç”Ÿæˆ plain text çµ¦ copy / history
    let txt = `ã€${holiday}ã€‘ï¼ˆ${start} è‡³ ${end}ï¼‰\nåé¡ï¼š${showQuota}ï¼ˆå…± ${participantIdx.length} äººåƒåŠ ï¼‰\n\n`;
    txt += "âœ… ä¸­ç±¤ï¼š\n";
    winnerNames.forEach(n=>{ txt += "  â€¢ " + n + "\n"; });
    if(loserNames.length>0){
      txt += "\nâŒ è½é¸ï¼š\n";
      loserNames.forEach(n=>{ txt += "  â€¢ " + n + "\n"; });
    }
    txt += "\nğŸ“Œ æç¤ºï¼šä¸­ç±¤è€…å¯ä»¥é¸æ“‡ç•¶æ¬¡æ‰€éœ€è¦çš„å‡æœŸã€‚\nè¦å‰‡ï¼šé€£çºŒå…©æ¬¡ä¸­ç±¤è€…ä¸‹ä¸€æ¬¡æœƒè¢«æš«åœæŠ½ç±¤ï¼Œè©²æ¬¡æŠ½ç±¤å®Œæˆå¾Œè‡ªå‹•è§£ç¦ï¼›é€£çºŒä¸‰æ¬¡è½é¸è€…ç¬¬ 4 æ¬¡å¿…ä¸­ã€‚";
    lastPlainText = txt;

    saveHistory({
      holidayId, holiday, start, end,
      quota:q, realWinners:winnersIdx.length,
      participants:participantIdx.length,
      winners:winnerNames, losers:loserNames,
      text:txt, time:new Date().toISOString()
    });
    renderHistory();
    // é‡æ–°ç•« pillsï¼Œä»¤ç¦ç”¨ / å¿…ä¸­æç¤ºå³æ™‚æ›´æ–°
    buildPills();
  }

  function clearResult(){
    resultDiv.textContent = "æš«æ™‚ä»²æœªæœ‰çµæœã€‚";
    resultStatus.textContent = "æœªæŠ½ç±¤";
    resultStatus.className = "badge badge-gray";
    lastPlainText = "";
  }

  function copyResult(){
    const text = lastPlainText || resultDiv.textContent.trim();
    if(!text){ return; }
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>{
        const btn = document.getElementById("copy-btn");
        btn.textContent = "âœ… å·²è¤‡è£½";
        setTimeout(()=>{ btn.textContent = "ğŸ“‹ Copy çµæœ"; }, 1200);
      }).catch(()=>{
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text){
    const textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try { document.execCommand("copy"); } catch(e){}
    document.body.removeChild(textarea);
    alert("å·²è¤‡è£½çµæœã€‚");
  }

  // History functions
  const HISTORY_KEY = STORAGE_KEY; // æ²¿ç”¨ä¹‹å‰ key

  function loadHistory(){
    try{
      const raw = localStorage.getItem(HISTORY_KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    }catch(e){ return []; }
  }

  function saveHistoryArray(arr){
    try{
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    }catch(e){}
  }

  function saveHistory(entry){
    let arr = loadHistory();
    arr.push(entry);
    if(arr.length > 50) arr = arr.slice(arr.length-50);
    saveHistoryArray(arr);
  }

  function renderHistory(){
    const baseArr = loadHistory();
    const arr = baseArr.map((v,i)=>({v,i})).reverse(); // å¸¶åŸå§‹ index
    historyList.innerHTML = "";
    if(arr.length===0){
      historyList.innerHTML = '<div style="font-size:13px; color:#6b7280;">æš«æ™‚æœªæœ‰ç´€éŒ„ã€‚</div>';
      return;
    }
    arr.forEach(itemWrap=>{
      const item = itemWrap.v;
      const originalIndex = itemWrap.i;
      const div = document.createElement("div");
      div.className = "history-item";
      div.dataset.index = originalIndex;
      const timeStr = new Date(item.time).toLocaleString("zh-HK", { hour12:false });

      let ruleTag = "";
      if(item.realWinners > item.quota){
        ruleTag = '<span class="history-rule-tag">å«ã€Œä¸‰æ¬¡è½é¸å¿…ä¸­ã€</span>';
      }

      div.innerHTML = `
        <div class="history-meta">
          <span>${item.holiday}ï¼ˆ${item.start} è‡³ ${item.end}ï¼‰</span>
          <span>${timeStr}</span>
        </div>
        <div class="history-meta" style="margin-top:-4px; margin-bottom:4px;">
          <span>åé¡ï¼š${item.quota}ï¼ˆå¯¦éš›ä¸­ç±¤ï¼š${item.realWinners}ï¼‰</span>
          <span>
            ${ruleTag}
            <button class="history-delete-btn" data-index="${originalIndex}" title="ç§»é™¤æ­¤ç´€éŒ„">ç§»é™¤</button>
          </span>
        </div>
        <div class="history-text">${item.text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
      `;
      historyList.appendChild(div);
    });
  }

  function deleteHistoryEntry(originalIndex){
    let arr = loadHistory();
    if(originalIndex < 0 || originalIndex >= arr.length) return;
    arr.splice(originalIndex,1);
    saveHistoryArray(arr);
    renderHistory();
  }

  function resetRules(){
    if(!confirm("ç¢ºå®šè¦ RESET å—ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰é€£çºŒä¸­ç±¤/è½é¸ç´€éŒ„åŠæ­·å²ç´€éŒ„ã€‚")){
      return;
    }
    try{
      localStorage.removeItem(STREAK_KEY);
      localStorage.removeItem(HISTORY_KEY);
    }catch(e){}
    clearResult();
    buildPills();
    renderHistory();
  }

  // Event binding
  document.getElementById("draw-btn").onclick = drawLots;
  document.getElementById("clear-result-btn").onclick = clearResult;
  document.getElementById("copy-btn").onclick = copyResult;
  document.getElementById("reset-rules-btn").onclick = resetRules;

  historyList.addEventListener("click", (e)=>{
    const btn = e.target.closest(".history-delete-btn");
    if(!btn) return;
    const idx = parseInt(btn.dataset.index,10);
    if(isNaN(idx)) return;
    deleteHistoryEntry(idx);
  });

  // init
  buildPills();
  clearResult();
  renderHistory();
</script>

</body>
</html>
